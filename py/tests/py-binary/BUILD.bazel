load("@aspect_bazel_lib//lib:run_binary.bzl", "run_binary")
load("@aspect_bazel_lib//lib:testing.bzl", "assert_contains")
load("@pypi//:requirements.bzl", "requirement")
load("//bazel:defs.bzl", "munge")
load("//py:defs.bzl", "py_binary", "py_test")

genrule(
    name = "run_py_test_help",
    outs = ["help.txt"],
    cmd = "$(execpath @pypi//pytest/entrypoints:pytest) --help >$@",
    tools = [
        "@pypi//pytest/entrypoints:pytest",
    ],
)

assert_contains(
    name = "test__run_py_test_help",
    actual = "help.txt",
    expected = "junit_logging (string):",
)

#################
# Case 2:
# The main property can be inferred from the target name.
py_binary(
    name = "main_from_name",
    srcs = ["main_from_name.py"],
)

run_binary(
    name = "run_main_from_name",
    outs = ["main_from_name.out"],
    args = ["$(execpath main_from_name.out)"],
    tool = "main_from_name",
)

assert_contains(
    name = "test__main_from_name",
    actual = "main_from_name.out",
    expected = "running main_from_name",
)

#################
# Case 3: Runfiles from pip works
py_test(
    name = "runfiles_from_pip_test",
    srcs = ["runfiles_from_pip.py"],
    data = ["test_data.txt"],
    main = "runfiles_from_pip.py",
    deps = [
        requirement("bazel-runfiles"),
    ],
)
