# Adapted from CPython Lib/venv/scripts/common/activate

set -eu -o pipefail

deactivate () {
    # reset old environment variables
    if [ -n "${_OLD_VIRTUAL_PATH:-}" ] ; then
        PATH="${_OLD_VIRTUAL_PATH:-}"
        export PATH
        unset _OLD_VIRTUAL_PATH
    fi

    if [ "${_OLD_VIRTUAL_PYTHONHOME:-}" == "_activate_undef" ]; then
       unset _OLD_VIRTUAL_PYTHONHOME
       unset PYTHONHOME
    elif [ -n "${_OLD_VIRTUAL_PYTHONHOME:-}" ] ; then
        PYTHONHOME="${_OLD_VIRTUAL_PYTHONHOME:-}"
        export PYTHONHOME
        unset _OLD_VIRTUAL_PYTHONHOME
    fi

    # Call hash to forget past locations. Without forgetting
    # past locations the $PATH changes we made may not be respected.
    # See "man bash" for more details. hash is usually a builtin of your shell
    hash -r 2> /dev/null

    if [ -n "${_OLD_VIRTUAL_PS1:-}" ] ; then
        PS1="${_OLD_VIRTUAL_PS1:-}"
        export PS1
        unset _OLD_VIRTUAL_PS1
    fi

    unset VIRTUAL_ENV
    unset VIRTUAL_ENV_PROMPT
    if [ ! "${1:-}" = "nondestructive" ] ; then
    # Self destruct!
        unset -f deactivate
    fi
}

{{DEBUG}}

# unset irrelevant variables
deactivate nondestructive

# For ZSH, emulate BASH_SOURCE.
# The runfiles library code has some deps on this so we just set it :/
: "${BASH_SOURCE:=$0}"

VIRTUAL_ENV="$(realpath "$(dirname "$(dirname "${BASH_SOURCE}")")")"
export VIRTUAL_ENV

# unset PYTHONHOME if set
# this will fail if PYTHONHOME is set to the empty string (which is bad anyway)
# could use `if (set -u; : $PYTHONHOME) ;` in bash.
#
# Note that since we are going to set PYTHONHOME ourselves in the case of a
# hermetic interpreter, we need to explicitly unset that when deactivating.
if [ -n "${PYTHONHOME:-}" ] ; then
    _OLD_VIRTUAL_PYTHONHOME="${PYTHONHOME:-}"
    unset PYTHONHOME
else
    _OLD_VIRTUAL_PYTHONHOME="_activate_undef"
fi

_OLD_VIRTUAL_PATH="$PATH"

# Aspect additions
# We set these before runfiles initialization so that we can use it as part of a fallback path
{{ENVVARS}}

# Initialize the runfiles interpreter if we're using one. Note that this happens
# AFTER unsetting the PYTHONHOME so that we can set PYTHONHOME if we're using a
# full bundled interpreter.
{{RUNFILES_INTERPRETER}}

PATH="$VIRTUAL_ENV/bin:$PATH"
export PATH

# Call hash to forget past commands. Without forgetting
# past commands the $PATH changes we made may not be respected
hash -r 2> /dev/null

set +eu +o pipefail
