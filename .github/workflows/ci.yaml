name: CI

# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

concurrency:
  # Cancel previous actions from the same PR or branch except 'main' branch.
  # See https://docs.github.com/en/actions/using-jobs/using-concurrency and https://docs.github.com/en/actions/learn-github-actions/contexts for more info.
  group: concurrency-group::${{ github.workflow }}::${{ github.event.pull_request.number > 0 && format('pr-{0}', github.event.pull_request.number) || github.ref_name }}${{ github.ref_name == 'main' && format('::{0}', github.run_id) || ''}}
  cancel-in-progress: ${{ github.ref_name != 'main' }}

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    if: always() && !cancelled()
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      - uses: pre-commit/action@v3.0.1
        continue-on-error: true
      - name: Send automated commit
        run: |
          if ! git diff --quiet; then
            git config --local user.name "aspect-marvin[bot]"
            git config --local user.email "<marvin@aspect.build>"
            git add .
            git commit --message="Pre-commit changes"

            for backoff in 5 10 15 20 25 30 runout; do
              if ! git push; then
                sleep $backoff
              elif [ "$backoff" = "runout" ]; then
                echo "ERROR: Failed to push commits!" >&2
                exit 1
              else
                break
              fi
            done
          fi

  verify-bcr-patches:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: patch --dry-run -p1 --fuzz 0 < .bcr/patches/*.patch

  test-release:
    runs-on: ubuntu-22.04-32core
    steps:
      - uses: actions/checkout@v4

      - name: Build Rust Binaries
        env:
          DEST: artifacts
        run: |
          rm -rf ${{ env.DEST }}
          mkdir -p ${{ env.DEST }}
          FLAGS=(--bazelrc=.github/workflows/ci.bazelrc)

          # Query for deliver verbs (see bazel/release/release.bzl)
          TARGETS=$(bazel $FLAGS query 'attr(tags, "cd:verb:deliver", //...)')

          # Run each one of those targets to produce and "deliver" artifacts
          # into the target dir.
          #
          # These delivery targets are expected to lay down <asset> and <asset>.sha256
          for target in $TARGETS; do
            bazel $FLAGS run $target -- $(realpath ${{ env.DEST }})
          done

      - name: Mock generate integrities
        run: |
          cat <<EOF
          "Generated during release by release_prep.sh, using integrity.jq"

          RELEASED_BINARY_INTEGRITY = $(jq \
            --from-file .github/workflows/integrity.jq \
            --slurp \
            --raw-input artifacts*/*.sha256 \
          )
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: artifacts/
          retention-days: 1
        
  # For branch protection settings, this job provides a "stable" name that can be used to gate PR merges
  # on "all matrix jobs were successful".
  conclusion:
    needs:
      - verify-bcr-patches
      - test-release
      - pre-commit
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: technote-space/workflow-conclusion-action@45ce8e0eb155657ab8ccf346ade734257fd196a5 # v3.0.3

      # Note: possible conclusion values:
      # https://github.com/technote-space/workflow-conclusion-action/blob/main/src/constant.ts
      - name: report success
        if: ${{ env.WORKFLOW_CONCLUSION == 'success' }}
        working-directory: /tmp
        run: echo ${{ env.WORKFLOW_CONCLUSION }} && exit 0

      - name: report failure
        if: ${{ env.WORKFLOW_CONCLUSION == 'failure' }}
        working-directory: /tmp
        run: echo ${{ env.WORKFLOW_CONCLUSION }} && exit 1
